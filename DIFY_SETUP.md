# Dify é›†æˆè®¾ç½®æŒ‡å—

## æ¦‚è¿°

æœ¬é¡¹ç›®å·²é›†æˆ Dify AI èŠå¤©åº”ç”¨ï¼Œç”¨äºæä¾›æ™ºèƒ½å­¦ç§‘å®¶æ•™æœåŠ¡ã€‚Dify åº”ç”¨åœ°å€ï¼š
https://cloud.dify.ai/app/59063635-af04-4038-a8d2-972dec4eea87

## å¿«é€Ÿå¼€å§‹

### 1. è·å– Dify API Key

1. è®¿é—® [Dify åº”ç”¨é¡µé¢](https://cloud.dify.ai/app/59063635-af04-4038-a8d2-972dec4eea87)
2. ç™»å½•ä½ çš„ Dify è´¦æˆ·
3. åœ¨å·¦ä¾§èœå•ä¸­é€‰æ‹© "API è®¿é—®"
4. å¤åˆ¶ API Keyï¼ˆæ ¼å¼ï¼šapp-xxxxxxï¼‰

### 2. é…ç½®ç¯å¢ƒå˜é‡

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env.local` æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰ï¼š

```env
# Dify API é…ç½®
DIFY_API_KEY=app-HCrh4FLjnjcUzs0S35MI4HO2

# å…¶ä»–ç¯å¢ƒå˜é‡...
NEXTAUTH_SECRET=your_nextauth_secret
NEXTAUTH_URL=http://localhost:3000
```

### 3. æµ‹è¯•é…ç½®

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯é…ç½®ï¼š

```bash
node test-dify-integration.js
```

å¦‚æœé…ç½®æ­£ç¡®ï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š
- âœ… DIFY_API_KEY å·²è®¾ç½®
- âœ… API è¿æ¥æˆåŠŸï¼

### 4. å¯åŠ¨åº”ç”¨

```bash
npm run dev
```

## ğŸ‰ èŠå¤©åº”ç”¨é›†æˆæˆåŠŸ

**åº”ç”¨ç±»å‹**: Dify èŠå¤©åº”ç”¨ï¼ˆä¸æ˜¯å·¥ä½œæµåº”ç”¨ï¼‰

**API ç«¯ç‚¹**: `/chat-messages`ï¼ˆä¸æ˜¯ `/workflows/run`ï¼‰

**è¯·æ±‚æ ¼å¼**: 
```json
{
  "inputs": {
    "subject": "æ•°å­¦",
    "grade": "é«˜ä¸€"
  },
  "query": "è§£æ–¹ç¨‹ï¼š2x + 5 = 13",
  "response_mode": "blocking",
  "user": "user123"
}
```

**å…³é”®ç‰¹ç‚¹**:
- âœ… æ”¯æŒå¯¹è¯è¿ç»­æ€§ï¼ˆconversation_idï¼‰
- âœ… æ”¯æŒæµå¼å’Œé˜»å¡æ¨¡å¼
- âœ… è‡ªåŠ¨å¤„ç†å­¦ç§‘å’Œå¹´çº§ä¸Šä¸‹æ–‡
- âœ… è¿”å›ç»“æ„åŒ–çš„æ•™å­¦å†…å®¹

## API ä½¿ç”¨æ–¹æ³•

### æµå¼è°ƒç”¨ï¼ˆæ¨èï¼‰

```typescript
import { askDifyTeacherStream } from '@/lib/dify';

// æµå¼è°ƒç”¨ç¤ºä¾‹
for await (const chunk of askDifyTeacherStream({
  query: "è§£æ–¹ç¨‹ï¼š2x + 5 = 13",
  subject: "æ•°å­¦",
  grade: "åˆäºŒ",
  user: "user123"
})) {
  console.log('äº‹ä»¶:', chunk.event);
  if (chunk.answer) {
    console.log('å›ç­”ç‰‡æ®µ:', chunk.answer);
  }
}
```

### é˜»å¡è°ƒç”¨

```typescript
import { askDifyTeacher } from '@/lib/dify';

// é˜»å¡è°ƒç”¨ç¤ºä¾‹
const result = await askDifyTeacher({
  query: "ä»€ä¹ˆæ˜¯äºŒæ¬¡å‡½æ•°ï¼Ÿ",
  subject: "æ•°å­¦",
  grade: "é«˜ä¸€",
  user: "user123"
});

console.log('å®Œæ•´å›ç­”:', result.answer);
console.log('å¯¹è¯ID:', result.conversation_id);
console.log('Tokenä½¿ç”¨:', result.metadata.usage.total_tokens);
```

### å¯¹è¯è¿ç»­æ€§

```typescript
// å¼€å§‹æ–°å¯¹è¯
const firstResult = await askDifyTeacher({
  query: "è§£æ–¹ç¨‹ï¼š2x + 5 = 13",
  subject: "æ•°å­¦",
  grade: "åˆäºŒ",
  user: "user123"
});

// ç»§ç»­å¯¹è¯
const secondResult = await askDifyTeacher({
  query: "å¦‚ä½•éªŒè¯è¿™ä¸ªç­”æ¡ˆæ˜¯å¦æ­£ç¡®ï¼Ÿ",
  subject: "æ•°å­¦",
  grade: "åˆäºŒ",
  user: "user123",
  conversationId: firstResult.conversation_id
});
```

## èŠå¤©åº”ç”¨é…ç½®

### è¾“å…¥å‚æ•°

èŠå¤©åº”ç”¨æ¥æ”¶ä»¥ä¸‹è¾“å…¥å‚æ•°ï¼š

- `query` (å¿…éœ€): å­¦ç”Ÿçš„é—®é¢˜æˆ–é¢˜ç›®
- `inputs.subject` (å¯é€‰): å­¦ç§‘åç§°ï¼Œé»˜è®¤ä¸º "æ•°å­¦"ï¼Œå¿…é¡»æ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼š
  - æ•°å­¦ã€è¯­æ–‡ã€è‹±è¯­ã€ç‰©ç†ã€åŒ–å­¦ã€ç”Ÿç‰©ã€æ”¿æ²»ã€å†å²ã€åœ°ç†
- `inputs.grade` (å¯é€‰): å¹´çº§ï¼Œé»˜è®¤ä¸º "é«˜ä¸€"

### æç¤ºè¯æ¨¡æ¿

å·¥ä½œæµä½¿ç”¨ä»¥ä¸‹æç¤ºè¯æ¨¡æ¿ï¼š

```jinja2
{% set subject = subject | default("æ•°å­¦") %}
{% set grade = grade | default("é«˜ä¸€") %}
{% set user_query = query | default("") %}

ä½ æ˜¯"å²­é¹¿AI"çš„å­¦ç§‘å®¶æ•™ï¼Œé¢å‘ K12ã€‚ä½ çš„ç›®æ ‡ï¼šç”¨ã€çŸ¥è¯†åº“å‘½ä¸­çš„èµ„æ–™ã€‘ç»™å‡º
1) æ­£ç¡®ä¸”"å¯éªŒè¯"çš„è§£é¢˜æ­¥éª¤ï¼Œ
2) é€‚åˆå­¦ç”Ÿå¹´çº§çš„è®²è§£ï¼Œ
3) æ˜ç¡®å‘Šè¯‰å­¦ç”Ÿä¸‹ä¸€æ­¥ç»ƒä¹ æ–¹å‘ã€‚

ã€èº«ä»½ä¸è¾¹ç•Œã€‘
- å­¦ç§‘ï¼š{{ subject }}ï¼›å¹´çº§ï¼š{{ grade }}ã€‚
- åªä¾æ®æˆ‘æä¾›çš„èµ„æ–™ï¼ˆçŸ¥è¯†åº“æ£€ç´¢ç‰‡æ®µä¸é¢˜å¹²ï¼‰ã€‚èµ„æ–™ç¼ºå¤±æˆ–çŸ›ç›¾æ—¶ï¼Œè¯·æ˜ç¡®è¯´"æˆ‘ä¸ç¡®å®š"ã€‚

ã€é¢˜ç›®/é—®é¢˜ã€‘
{{ user_query }}

ã€è¾“å‡ºæ ¼å¼ï¼ˆä¸¥æ ¼éµå®ˆï¼‰ã€‘
1. **è§£é¢˜æ€è·¯**
2. **æ­¥éª¤**
3. **ç­”æ¡ˆ**
4. **æ˜“é”™ç‚¹/æ£€æŸ¥**
5. **å‚è€ƒèµ„æ–™**
---META---
{"subject":"{{subject}}","grade":"{{grade}}"}
```

### è¾“å‡ºæ ¼å¼

AI ä¼šæŒ‰ç…§ä»¥ä¸‹ç»“æ„åŒ–æ ¼å¼å›ç­”ï¼š

1. **è§£é¢˜æ€è·¯** - åˆ†æé—®é¢˜çš„æ€è·¯
2. **æ­¥éª¤** - è¯¦ç»†çš„è§£é¢˜æ­¥éª¤
3. **ç­”æ¡ˆ** - æœ€ç»ˆç­”æ¡ˆ
4. **æ˜“é”™ç‚¹/æ£€æŸ¥** - å¸¸è§é”™è¯¯å’Œæ£€æŸ¥è¦ç‚¹
5. **å‚è€ƒèµ„æ–™** - ç›¸å…³å‚è€ƒèµ„æ–™

## API ç«¯ç‚¹

### POST /api/qa/stream

æµå¼é—®ç­”æ¥å£ï¼Œæ”¯æŒå®æ—¶è¿”å› AI å›ç­”ã€‚

**è¯·æ±‚ä½“ï¼š**
```json
{
  "query": "è§£æ–¹ç¨‹ï¼š2x + 5 = 13",
  "subject": "æ•°å­¦",
  "grade": "åˆäºŒ",
  "conversationId": "optional-conversation-id"
}
```

**å“åº”ï¼š**
Server-Sent Events (SSE) æ ¼å¼ï¼š

```
data: {"event":"workflow_started","task_id":"xxx"}

data: {"event":"agent_message","answer":"æ ¹æ®é¢˜ç›®..."}

data: {"event":"message_end","metadata":{...}}
```

## æ•…éšœæ’é™¤

### å¸¸è§é”™è¯¯

1. **401 Unauthorized**
   - æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤ API Key æ˜¯å¦æœ‰æ•ˆä¸”æœªè¿‡æœŸ

2. **404 Not Found**
   - æ£€æŸ¥å·¥ä½œæµ ID æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤å·¥ä½œæµæ˜¯å¦å·²å‘å¸ƒ

3. **403 Forbidden**
   - æ£€æŸ¥ API Key æƒé™
   - ç¡®è®¤è´¦æˆ·æœ‰è®¿é—®å·¥ä½œæµçš„æƒé™

4. **429 Too Many Requests**
   - è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œç­‰å¾…åé‡è¯•
   - è€ƒè™‘å®ç°è¯·æ±‚é™æµ

### è°ƒè¯•å»ºè®®

1. ä½¿ç”¨æµ‹è¯•è„šæœ¬éªŒè¯åŸºæœ¬é…ç½®
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. æŸ¥çœ‹åº”ç”¨æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
4. åœ¨å¼€å‘ç¯å¢ƒä¸­å¯ç”¨è¯¦ç»†é”™è¯¯ä¿¡æ¯

## æ€§èƒ½ä¼˜åŒ–

1. **ç¼“å­˜æœºåˆ¶**: ç›¸åŒé—®é¢˜çš„ç­”æ¡ˆä¼šè¢«ç¼“å­˜ï¼Œé¿å…é‡å¤è°ƒç”¨
2. **æµå¼å“åº”**: ä½¿ç”¨æµå¼æ¨¡å¼è·å¾—æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
3. **é”™è¯¯é‡è¯•**: è‡ªåŠ¨é‡è¯•å¤±è´¥çš„è¯·æ±‚
4. **è¯·æ±‚é™æµ**: é˜²æ­¢è¿‡äºé¢‘ç¹çš„è¯·æ±‚

## å®‰å…¨è€ƒè™‘

1. **API Key ä¿æŠ¤**: ç»ä¸åœ¨å®¢æˆ·ç«¯æš´éœ² API Key
2. **ç”¨æˆ·è®¤è¯**: ç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·å¯ä»¥è®¿é—® API
3. **è¯·æ±‚éªŒè¯**: éªŒè¯æ‰€æœ‰è¾“å…¥å‚æ•°
4. **é”™è¯¯å¤„ç†**: ä¸åœ¨é”™è¯¯ä¿¡æ¯ä¸­æš´éœ²æ•æ„Ÿä¿¡æ¯

## ç›‘æ§å’Œæ—¥å¿—

åº”ç”¨ä¼šè‡ªåŠ¨è®°å½•ï¼š
- API è°ƒç”¨ç»Ÿè®¡
- å“åº”æ—¶é—´ (TTFT - Time to First Token)
- é”™è¯¯æ—¥å¿—
- ç”¨æˆ·è¡Œä¸ºå®¡è®¡

æŸ¥çœ‹æ—¥å¿—ä»¥ç›‘æ§ç³»ç»Ÿå¥åº·çŠ¶å†µå’Œæ€§èƒ½ã€‚
